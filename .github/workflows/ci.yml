name: CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # STEP 1 ‚Äî Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v3

    # STEP 2 ‚Äî Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    # STEP 3 ‚Äî Install Dependencies
    - name: Install Dependencies
      run: pip install -r requirements.txt

    # STEP 4 ‚Äî Docker Build
    - name: Docker Build
      run: docker build -t flask-crud-app .

    # ==========================================================
    # üéâ SUCCESS NOTIFICATION
    # ==========================================================
    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        subject: "‚úî SUCCESS ‚Äî CI Pipeline Passed"
        to: kalashrajput5725.com
        from: ${{ secrets.EMAIL_USER }}
        body: |
          üéâ CI Pipeline Succeeded!

          Project: flask-crud-app  
          Status: SUCCESS ‚úî  
          Branch: ${{ github.ref }}
          Run ID: ${{ github.run_id }}

          All stages passed successfully.

    # ==========================================================
    # ‚ùå FAILURE NOTIFICATION
    # ==========================================================
    - name: Send Failure Email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        subject: "‚ùå FAILURE ‚Äî CI Pipeline Failed"
        to: kalashrajput5725.com
        from: ${{ secrets.EMAIL_USER }}
        body: |
          ‚ùå CI Pipeline FAILED!

          Project: flask-crud-app  
          Status: FAILURE  
          Branch: ${{ github.ref }}
          Run ID: ${{ github.run_id }}

          Check logs here:
          https://github.com/${{ github.repository }}/actions

    # ==========================================================
    # ‚ö† ALWAYS SEND SUMMARY (SUCCESS/FAILURE)
    # ==========================================================
    - name: Send Completion Summary
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        subject: "‚Ñπ Pipeline Completed ‚Äî Status: ${{ job.status }}"
        to: kalashrajput5725@gmail.com
        from: ${{ secrets.EMAIL_USER }}
        body: |
          CI Pipeline finished running.

          Final Status: ${{ job.status }}
          Branch: ${{ github.ref }}
          Run ID: ${{ github.run_id }}

          Full logs:
          https://github.com/${{ github.repository }}/actions
